---
title: "Final results for NIEHS epi-stats workshop"
author: "Jenna Krall"
date: "June 15, 2015"
output: 
  html_document: 
    theme: journal
    toc: true
    numbered_sections: true
    toc_depth: 2
---


```{r setup, echo = F, message = F, warning = F}
# load knitr package 
library(knitr)

# set knitr options
opts_chunk$set(message=FALSE, echo = F,
    warning = F)
    #fig.height = 5, fig.width = 10)

```


```{r libraries}
# load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(psych)
library(MASS)
library(RColorBrewer)
library(reshape2)
library(rpart)
library(gridExtra)
library(rattle)
```


```{r opt1}
# Set options for rpart
fit.control <- rpart.control(xval = 100, cp = 0, minbucket = 5, maxcompete = 4)

# Source functions
source("niehs-epistats-fn.R")

# Set directory
opts_knit$set(root.dir = "~/Dropbox/NIEHSmixtures")


```

# Simulated dataset 1

```{r read1}
dat <- read.csv("DataSet1.csv", stringsAsFactors = F)
covar <- paste0("X", seq(1, 7))
outcome <- "Y"
confound <- "Z"

covar1 <- c(paste0("rPC", seq(1, 4)), toupper(covar))
labels1 <- data.frame(covar1, covar1)
```


```{r sim1}
sim1 <- niehs_outer(dat, outcome, confound, covar, cp1 = 0.02, nfac = 4, labels1 = labels1)
```


# Simulated dataset 2

```{r read2}
dat <- read.csv("DataSet2.csv", stringsAsFactors = F)
covar <- paste0("x", seq(1, 14))
outcome <- "y"
confound <- "z1 + ns(z2, 3) + z3"


pc1 <- paste0("rPC", seq(1, 6))
covar1 <- c(pc1, covar)
covar2 <- c(pc1, toupper(covar))
labels1 <- data.frame(covar1, covar2)
```


```{r sim2}
sim2 <- niehs_outer(dat, outcome, confound, covar, cp1 = 0.015, nfac = 6, labels1 = labels1)
```


# Real world dataset

```{r readreal}
dat <- read.csv("realdata/niehs_mix_real.csv", stringsAsFactors = F)
cn <- colnames(dat)
ss <- substr(cn, 1, 3)
covar <- cn[ss == "lip"]
outcome <- "mdi"
confound <- paste(cn[ss %in% c("chi", "mom")], collapse = "+")


# get labels

# Separate into strings/ numbers
ss1 <- strsplit(covar, "_")
type1 <- sapply(ss1, function(x) x[2])
type2 <- sapply(ss1, function(x) x[3])


# Fix PCB numbers
wh1 <- which(substr(type1, 1, 3) == "pcb") 
type2[wh1] <- substring(type1[wh1], 4)
type1[wh1] <- substr(type1[wh1], 1, 3)

# Fix DDE
type1[type1 == "pp"] <- "pp_dde" 

# Get orders
type1 <- toupper(type1)
type2 <- as.numeric(type2)
types <- data.frame(type1, type2)
ords1 <- order(types[, 1], types[, 2])

# Fix 138/158, 196/203
type2a <- sapply(ss1, function(x) x[3])
wh1 <- which(!is.na(type2a) & type1 == "PCB")
type2[wh1] <- paste0(type2[wh1], "_", type2a[wh1])


# Merge to get label
labs <- paste0(type1, "_", type2)
labs[which(is.na(type2))] <- type1[which(is.na(type2))]


# Add in rPCs
lab1 <- paste0("rPC", seq(1, 4))

labels1 <- cbind(c(lab1, covar[ords1]), c(lab1, labs[ords1]))


# Rename dataset
colnames(dat)[colnames(dat) %in% covar] <- labs 


labels1 <- cbind(c(lab1, labs[ords1]), c(lab1, labs[ords1]))

covar <- labs
```


```{r real, fig.height = 10, fig.width = 8}
real <- niehs_outer(dat, outcome, confound, covar, cp1 = 0.03, nfac = 4, log1 = T, labels1 = labels1)
```


```{r varexp}
varexp <- c(sim1$varexp, sim2$varexp, real$varexp)
varconf <- c(sim1$varconf, sim2$varconf, real$varconf)
varexp <- data.frame(c("Sim 1", "Sim 2", "Real data"), varexp, varconf)
colnames(varexp) <- c("Dataset", "% variance in exposures explained by rPCs", "% variance in y explained by confounders")
kable(varexp)
```


# Statistical significance for regression results

## Simulated dataset 1

```{r sigs}
dat1 <- sim1

dat1 <- dat1[["preg"]][["data"]]
wh1 <- which(dat1$LB > 0 | dat1$UB < 0)
dat1 <- dplyr::select(dat1, Estimate, Variable, LB, UB, Type, Group)
dat1[, c(1, 3, 4)] <- round(dat1[, c(1, 3, 4)], 2)
kable(dat1[wh1,])


```


## Simulated dataset 2



```{r sigs2}
dat1 <- sim2


dat1 <- dat1[["preg"]][["data"]]
wh1 <- which(dat1$LB > 0 | dat1$UB < 0)
dat1 <- dplyr::select(dat1, Estimate, Variable, LB, UB, Type, Group)
dat1[, c(1, 3, 4)] <- round(dat1[, c(1, 3, 4)], 2)
kable(dat1[wh1,])


```


## Real world dataset

```{r sigr}
dat1 <- real

dat1 <- dat1[["preg"]][["data"]]
wh1 <- which(dat1$LB > 0 | dat1$UB < 0)
dat1 <- dplyr::select(dat1, Estimate, Variable, LB, UB, Type, Group)
dat1[, c(1, 3, 4)] <- round(dat1[, c(1, 3, 4)], 2)
kable(dat1[wh1,])


```

# Get histograms to match C&RT output

```{r hist}

var1 <- c("X7", "X5", "X7", "X5", "X1", "X7", "X5", "X1", "X7", "X5", "X1")
lt <- c("<", ">=", "<", "<", ">=", ">=", ">=", "<", ">=", "<", ">=")
val <- c(-0.41, -0.12, -0.41, -0.12, 0.26,-0.41, -0.026, 0.16, -0.41, -0.026, 0.76)
fills1 <- data.frame(var1, lt, val, seq(1, length(var1)), stringsAsFactors = F)

#seq1 <- c(1, 3, 6, 2, 4, 7, 1, 5, 8)
#fills1 <- fills1[seq1, ]

#fills1 <- data.frame(fills1, seq(1, nrow(fills1)))

cols1 <- brewer.pal(4, "Dark2")
size2 <- 10

g4a <- getden(sim1, fills1[1 : 2,], cols1, lim1 = c(-3, 3), size1 = size2)$g1


g4b <- getden(sim1, fills1[3 : 5,], cols1, lim1 = c(-3, 3), size1 = size2)$g1
g4c <- getden(sim1, fills1[6 : 8,], cols1, lim1 = c(-3, 3), size1 =size2)$g1


g4d <- getden(sim1, fills1[9 : 11,], cols1, lim1 = c(-3, 3), size1 =size2)$g1
```


# Plots for abstract, poster, presentation

## Plots for abstract
```{r}
# Combined loadings and results for simulated data1

pdf("fig1a.pdf", height = 2.5, width = 4)
sim1$pload
graphics.off()

pdf("fig1b.pdf", height = 2.5, width = 6)
sim1[["preg"]][["g1"]]
graphics.off()




pdf("fig5a.pdf", height = 1.8, width = 8)
sim2$pload
graphics.off()

pdf("fig5b.pdf", height = 2, width = 9)
sim2[["preg"]][["g1"]]
graphics.off()


pdf("fig2a.pdf", height = 2.7, width = 9)
real$pload +  theme(axis.text.x = element_text(size = 5))
graphics.off()

pdf("fig2.pdf", height = 3, width = 9)
real[["preg"]][["g1"]]
graphics.off()

pdf("fig3.pdf", height = 3, width = 9)
#fancyRpartPlot(sim1[["crt1"]])
prp(sim1[["crt1"]], branch = 1, extra = 1, box.col = bcol[1], 
    split.box.col = bcol[2], fallen.leaves = T)
graphics.off()

h1 <- 1.5
w1 <- 1.5
h2 <- 2.25
pdf("fig4a.pdf", height = h1, width = w1)
g4a
graphics.off()


pdf("fig4b.pdf", height = h2, width = w1)
g4b
graphics.off()



pdf("fig4c.pdf", height = h2, width = w1)
g4c
graphics.off()



pdf("fig4d.pdf", height = h2, width = w1)
g4d
graphics.off()

```
